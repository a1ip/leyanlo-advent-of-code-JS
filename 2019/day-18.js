const inputIdx = 5;

const dirs = [
  [0, 1],
  [1, 0],
  [0, -1],
  [-1, 0],
];

function countSteps(rows, start, keys, doors) {
  // found all keys
  if (!Object.keys(keys).length) {
    return 0;
  }

  const queue = dirs.map((dir) => ({
    coords: [start[0] + dir[0], start[1] + dir[1]],
    steps: 1,
  }));
  const seen = {
    [start.join()]: true,
  };
  let minSteps = Number.MAX_SAFE_INTEGER;
  while (queue.length) {
    const {
      coords: [row, col],
      steps,
    } = queue.shift();
    const char = rows[row][col];
    if (seen[[row, col].join()]) {
      // skip if seen
      continue;
    }
    seen[[row, col].join()] = true;

    if (char === '#' || /[A-Z]/.test(char)) {
      // skip walls and doors
    } else if (char === '.') {
      queue.push(
        ...dirs.map((dir) => ({
          coords: [row + dir[0], col + dir[1]],
          steps: steps + 1,
        }))
      );
    } else if (/[a-z]/.test(char)) {
      const nextRows = rows.map((row) => [...row]);
      nextRows[row][col] = '.';
      if (doors[char]) {
        nextRows[doors[char][0]][doors[char][1]] = '.';
      }
      const nextStart = [row, col];
      const nextKeys = { ...keys };
      delete nextKeys[char];
      const nextDoors = { ...doors };
      delete nextDoors[char];
      minSteps = Math.min(
        minSteps,
        steps + countSteps(nextRows, nextStart, nextKeys, nextDoors)
      );
    }
  }
  return minSteps;
}

function solve(input) {
  const rows = input.split('\n').map((row) => row.split(''));
  let start;
  const keys = {};
  const doors = {};
  for (let i = 0; i < rows.length; i++) {
    for (let j = 0; j < rows[i].length; j++) {
      if (rows[i][j] === '@') {
        start = [i, j];
      } else if (/[a-z]/.test(rows[i][j])) {
        keys[rows[i][j]] = true;
      } else if (/[A-Z]/.test(rows[i][j])) {
        doors[rows[i][j].toLowerCase()] = [i, j];
      }
    }
  }

  rows[start[0]][start[1]] = '.';

  console.log(countSteps(rows, start, keys, doors));
}

const inputs = [];
inputs.push(`#########
#b.A.@.a#
#########`);

inputs.push(`########################
#f.D.E.e.C.b.A.@.a.B.c.#
######################.#
#d.....................#
########################`);

inputs.push(`########################
#...............b.C.D.f#
#.######################
#.....@.a.B.c.d.A.e.F.g#
########################`);

inputs.push(`#################
#i.G..c...e..H.p#
########.########
#j.A..b...f..D.o#
########@########
#k.E..a...g..B.n#
########.########
#l.F..d...h..C.m#
#################`);

inputs.push(`########################
#@..............ac.GI.b#
###d#e#f################
###A#B#C################
###g#h#i################
########################`);

inputs.push(`#################################################################################
#.#.....#.........#...S.#...............#...............#.......#.....#.........#
#.#.#.###.#.#####.#.###.#.###########.#.#.###.###########.###.#E#.###.#.#.#######
#...#.....#.#...#.#.#.#.#.#.........#.#.#...#.#...#.....#...#.#.#...#...#.#.....#
#.#########.#.#.###.#.#.###.#######I###.#.#.#.#.#.#.###.###.#.#.#.#.#####.#.###.#
#.#.......#...#...#s#.#.#...#.#.....#...#.#.#.#.#.#.#.#...#.#.#.#.#...#.U.#...#.#
#.#R#####.#######.#.#.#.#.###.#.#####.#.#.#.###.#.#.#B#.#.#.#.#.#####.#.#####.#.#
#.#.#...#.#.....#...#.#..i....#n#.....#.#.#.....#.....#.#.#.#.#.......#.#.....#.#
#.#.###.#.#.#.#.#####.#######.#.#.#.###.#.#############.###.#.###.#####.#.#####.#
#.#..l..#.#.#.#.#.......#...#.#.#.#.#.#.#...#.....#.#...#...#.#...#...#.#.....#w#
#.#.#####.#.#.###.#.###.#N#.###.###.#.#.###.#.###.#.#.###.###.#####.#.#######G#.#
#.#.#...#...#.....#.#...#.#.....#...#.#.#...#...#...#c......#.....#.#r........#.#
#.###.#.#####.#####.#.###.#######.###.#.#.#####.###########.#####.#.###########.#
#....g#.....#.....#.#...#...#.....#...#.#.#...#.#.....#...#...#...#...#...#.....#
###########W#######.#######.#####.###.#.#.#.#.#.#.###.#.#.#####F#####.#.###.#####
#...#.....#.........#......o#...#...#...#.#.#...#.#.#.#.#...#...#.....#.#...#...#
#.#.#.#.#######.#####.#######.#.###.#.###.#.#####.#.#.#.###.#.#.#.#####.#.###.#.#
#v#.#.#.........#j..#.#.......#.....#.#.#.#...#.....#.#.#...#.#.#.#...#...#..q#.#
###.#.###########.#.#.###.###########.#.#.###.#.#####.#.#.###.#.#.#.###.###.#.#.#
#...#.#.......#...#.O.#...#.#.......#...#...#...#...#.#.#.....#.#.#.#..k#...#.#.#
#.#.#K#.#P###.#.#######.###.#.#.#######.###.#####.#.#.#.###.#####.#.#.###.###.#.#
#.#.#.#.#...#.#.#.....#.#...#.#.........#.#.......#.#.#.#...#.L...#...#.#.#.#.#.#
#.#.#.#####.#.#.#.#####.#.#.#.###########.#########.#.#.###########.###.#.#.#H#.#
#.#.#.......#.#.J.#.....#.#.#...........#...#...#...#.#...#...V...#...#...#.#.#.#
#.###########.#####.###.#.#############.#.#.#.#.#.###.###.#.###.#.###.#.###.#.###
#.........#...#.......#.#.........#.#...#.#...#.#.....#.#...#.#.#..p#.#.....#...#
#.#####.###.###########.#.#.#####.#.#.###.#####.#####.#.#####.#.#####.#####.###.#
#.#...#...#...#.....#...#.#.....#...#...#.....#...#.#.#...#...#.#.....#.#...#.#.#
#.#.#.###.###.#.###.#.###.#####.#######.#####.###.#.#.###.#.#.#.#.#####.#.###.#.#
#.#.#...#...#.#.#...#.#.#...#.#.........#.....#...#.#...#.#.#.#...#.....#.....#.#
#.#.###.###.#.#.#.###.#.###.#.###########.#######.#.###.#.#.#.#####.#.#.#####.#.#
#.#.#.....#.#.#.#.....#.....#.......#...#.#.....#.....#.#...#.......#.#...#...#.#
#.#.#####.#.#.#.#######.#####.#.###.###.#.#.###.#####.#.#############.#####.###.#
#.#...#.#.#...#.#.....#.#...#.#...#.#...#.#.#.#.....#.#...#...#.....#...#...#...#
#.#.#.#.#.#####.#.#####.#.#Y#.###.#.#.###.#.#.#####.#####.#.#.#.###.###.#.###D#.#
#.#.#.#.#.#.....#.....#.#.#.....#.#.#...#.#...#.....#...#...#...#.#...#.....#.#.#
#.###.#.#.#####.#.###.#.#########.#.#.#.#.###.#.###.#.#.#########.###.#####.#.#.#
#.....#.#.....#.#...#.#...#.......#.#.#.#.....#...#.#.#.....#.......#.....#.#.#.#
#######.#####.#.###.#.###.#.#######.###.#.#######.###.#####.#.#####.#####.###.#.#
#...............#m..#.......#...................#.........#.......#...........#.#
#######################################.@.#######################################
#...........#.....#...............#.......#......y....#.......#...A...#.........#
#.###.#####.###.#.#.#############.#.#.###.#.###.#####.#.#####.#.#####.###.#####.#
#.#...#t..#x....#.#.#...........#.#.#...#.....#.#...#.#.#...#...#...#...#.....#.#
#.#.###.#.#######.#.#.#########.#.#.###.#.#####.#.###.#.#.#.#####.#.###.#####.###
#.#.....#.#.....#...#d#...#.....#.#.#.#.#.#.....#.#.....#.#.#.....#.#...#...#...#
#.#######.#.#######.#.###.#.#####.#.#.#.#.#.#####.#.#####.#.#.#######.###.#.###.#
#.#.......#.........#.....#.#.....#...#.#.#.#...#...#.....#.#.......#...M.#.....#
#.#.#########.###########.#.#####.###.#.#.#.#.#.#####.#####.#.#####.###########.#
#.#.........#.......#...#.#.....#.#...#.#.#...#.......#.#...#.....#.....#.......#
#.#########.#######.###.#.#####.#.#.###.#.###########.#.#.#############.#.#######
#.....#...#.#.......#...#.#a....#.#.#.#.#.#...#.....#...#.........#.....#.....#.#
#####.#.#.#.#.#######.###.#.#######.#.#.#.###.#.###.###.#########.#.#########.#.#
#.......#z#.#.........#...#...#.......#.#.....#.#...#.........#...#.........#.#.#
###########.#######.###.#####.#.#######.#####.#.###.#########.#.#########.###.#X#
#.........#.......#.#...#...#.....#...#.#.....#...#...#.......#.#.........#...#.#
#.#######.#######.###.###.#.#.#####.#.#.#.#####.#.###.#.#####.#.###.#.#####.###.#
#.#.....#.......#.......#.#.#.#.....#.#.#.#...#.#.#.#.#.#...#.#.#...#.#.....#...#
#.#.###.#######.#########.#.###.#####.#.#.#.#.###.#.#.###.#.###.#.###.#.#######.#
#...#.#.......#...#...#...#.#...#...#.#.#.#.#.#...#.#.....#.....#...#.#.#.......#
#####.#######.###.#.#.#.###.#.###.#.#.#.###.#.#.###.#######.#######.###.#.#####.#
#...........#.#.#...#.#.#.#...#.#.#...#.#...#.#.#.......#...#.....#.....#.....#.#
#.#######.#.#.#.#######.#.#####.#.#####.#.###.#.#.#######.#######.#.#########T#.#
#...#...#.#.#.#.......#.#......e#.#.....#.#.....#.........#.....#.#.......#...#.#
#####.#.###.#.#####.#.#.#.#####.#.#.#.###.#############.###.#.#.#.#######.#.###.#
#.....#...#.#.....#.#...#.....#.#.#.#...#.#...........#.#...#.#.#...#.....#.#.#.#
#.#######.#.#####.#.#######.#.#.#.#####.#.#.#########.###.###.#####.#.#####.#.#.#
#.......#.....#.#...#.....#.#.#.#.#.....#...#.....#.#.....#.#.....#.#.....#.#...#
#.#####.#####.#.#####.###.###.#.#.#.#########.###.#.#######.#####.#.#####.#.#.###
#...#.#.....#.........#.......#.#.#.....#...#...#.#.......#.....#...#...#...#...#
###.#.#####.###########.#########.#.###.#.###.#.#.#####.#.#.#.#######.#########.#
#.#.....#...#...#.......#.........#...#.#...#.#.#.....#.#.#.#.................#.#
#.#####.#.###.#C#.#####.#.###########.#.#.#.#.#.#####.###.#.#############.###.#.#
#...#...#...#.#...#...#.#.#...#...#...#.#.#...#.#...#.#...#.#.......#...#.#.#.#.#
#.###.#####.###.###.#.###.#.#.#.#.#####.#.#####.#.###.#.#.#.#.#####.#.#.#.#.#.#.#
#...#.....#...#...#.#...#.#.#...#...#...#.#...#.#.......#.#.#.#...#.#.#...#...#.#
#.#.###.#####.#####.###.#.#.#######.#.#.#.###.#.#######.###.#.#.#.#.#.#####.###.#
#.#...#.#.....#...#...#.#.#...#...#.#.#.#.....#...#f..#.#...#u#.#...#....b#.#...#
#.###.#.#.#####Q#.###.#.#.###.#.###.#.#.#####.###.#.#.###.#####.###.#####.###Z###
#...#...#.......#.....#....h..#.......#.#.......#...#...........#.......#.......#
#################################################################################`);

solve(inputs[inputIdx]);
